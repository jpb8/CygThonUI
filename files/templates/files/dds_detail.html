<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">


</head>
<body>
<div id="left" class="container">
    <h1>{{ dds.base_file }}</h1>
    <ul>
        <li>Project - {{ dds.project }}</li>
        <li>Uploaded - {{ dds.uploaded }}</li>
    </ul>
    <button onclick="window.location.href = '{{ dds.export_url }}';">Export File!</button>
    <button onclick="window.location.href = '{% url 'files:dds_mappings_export' %}';">Export Mappings
    </button>
    <div>
        <h2>All Functions</h2>
        <ul>
            <li>
                <form method="POST" action="{% url 'files:orphans' %}" id="dds-orphans">
                    {% csrf_token %}
                    <label>Import Mappings</label>
                    <select name="dtf-id">
                        {% if dtfs %}
                            {% for d in dtfs %}
                                <option value="{{ d.pk }}">{{ d.file }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                    <input hidden name="dds-id" value="{{ dds.pk }}">
                    <button type="submit">Find Orphans</button>
                </form>
            </li>
            <li>
                <div class="dds-util" data-id="{{ dds.pk }}"
                     data-url="{% url 'files:correct_dec_check' %}?id={{ dds.pk }}">
                    <button>Correct Device Check</button>
                </div>
            </li>
            <li>
                <form method="post" enctype="multipart/form-data" action="{% url 'files:fac_exist' %}" id="dds-facs">
                    {% csrf_token %}
                    <label>Import Mappings</label>
                    <input type="file" name="facs">
                    <input hidden name="dds-id" value="{{ dds.pk }}">
                    <button type="submit">Check All Facilities Exist</button>
                </form>
            </li>
            <li>
                <div class="dds-util" data-id="{{ dds.pk }}"
                     data-url="{% url 'files:correct_dec_check' %}?id={{ dds.pk }}">
                    <button>Correct Device Check</button>
                </div>
            </li>
            <li>
                <div class="dds-util" data-id="{{ dds.pk }}"
                     data-url="{% url 'files:unmapped_facs' %}?id={{ dds.pk }}">
                    <button>Check Missing Facilities</button>
                </div>
            </li>
        </ul>
    </div>
    <form method="post" enctype="multipart/form-data" action="{% url 'files:dds_add_mappings' %}" id="dds-mapping">
        {% csrf_token %}
        <label>Import Mappings</label>
        <input type="file" name="mappings">
        <select name="dtf-id">
            {% if dtfs %}
                {% for d in dtfs %}
                    <option value="{{ d.pk }}">{{ d.file }}</option>
                {% endfor %}
            {% endif %}
        </select>
        <input hidden name="dds-id" value="{{ dds.pk }}">
        <button type="submit">Map!</button>
    </form>
    <div class="modal fade" id="response-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">Response Data</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="modal-body">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>
</body>


<script
        src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
        crossorigin="anonymous"></script>
<!-- Latest compiled JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
<script>
    $(document).ready(function () {

        function createPointTable(points, rows) {
            var table = "<table style='width:100%'>" + buildHeaders(rows);
            for (i = 0; i < points.length; i++) {
                table += "<tr>";
                for (j = 0; j < rows.length; j++) {
                    table += "<td>" + points[i][rows[j]] + "</td>";
                }
                table += "</tr>";
            }
            table += "</table>";
            return table
        }

        function buildHeaders(rows) {
            var headerHTML = "<tr>";
            for (i = 0; i < rows.length; i++) {
                headerHTML += "<th>" + rows[i] + "</th>";
            }
            headerHTML += "</tr>";
            return headerHTML
        }

        function createResponseHTML(data) {
            var text = "<h2>" + data.header + "</h2>";
            var table = createPointTable(data.responseData, data.rows);
            text += table;
            return text
        }

        $("#dds-mapping").submit(function (event) {
            event.preventDefault();
            var formData = new FormData($(this)[0]);
            var _url = $(this).attr("action");
            var method = "POST";
            $.ajax({
                url: _url,
                type: method,
                data: formData,
                contentType: false,
                processData: false,
                success: function (data) {
                    var errs = data.errors;
                    var text = "";
                    for (i = 0; i < errs.length; i++) {
                        text += "<h2>Upload Errors</h2>";
                        text += "<p>" + errs[i] + "</p>";
                    }
                    $("#dds-success").html(text);
                },
                error: function (request, error) {
                    alert("Request: " + JSON.stringify(request));
                }
            });
        });

        $("#dds-orphans").submit(function (event) {
            event.preventDefault();
            var formData = $("#dds-orphans").serialize();
            var _url = $(this).attr("action");
            var method = "POST";
            $.ajax({
                url: _url,
                type: method,
                data: formData,
                success: function (data) {
                    var text = createResponseHTML(data);
                    $("#modal-body").html(text);
                    $('#response-modal').modal('show');
                },
                error: function (request, error) {
                    alert("Request: " + JSON.stringify(request));
                }
            });
        });

        $("#dds-facs").submit(function (event) {
            event.preventDefault();
            var formData = new FormData($(this)[0]);
            var _url = $(this).attr("action");
            var method = "POST";
            $.ajax({
                url: _url,
                type: method,
                data: formData,
                contentType: false,
                processData: false,
                success: function (data) {
                    var text = createResponseHTML(data);
                    $("#modal-body").html(text);
                    $('#response-modal').modal('show');
                },
                error: function (request, error) {
                    alert("Request: " + JSON.stringify(request));
                }
            });
        });

        $(".dds-util").click(function () {
            var _url = $(this).data("url");
            var _data = {id: $(this).data("id")};
            var method = "POST";
            $.ajax({
                url: _url,
                type: method,
                data: _data,
                success: function (data) {
                    var text = createResponseHTML(data);
                    $("#modal-body").html(text);
                    $('#response-modal').modal('show');
                },
                error: function (request, error) {
                    alert("Request: " + JSON.stringify(request));
                }
            })


        })


    });
</script>
</html>